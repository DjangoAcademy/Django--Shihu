{% extends 'base.html' %}
{% load blog_extra %}
{% load comment_extras %}
{% load staticfiles %}
{% block title %}{{ answer.title }}{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                {% if request.session.is_login %}
                    <article class="answer post-{{ answer.id }}">
                        <header class="entry-header">
                            <h1 class="entry-title">{{ answer.title }}</h1>
                            <div class="entry-meta">
                    <span class="post-date"><a><time class="entry-date"
                                                     datetime="{{ answer.created_time }}">{{ answer.created_time }}</time></a></span>
                                <span class="post-author"><a href="#">{{ answer.author }}</a></span>
                                <span class="comments-link"><a
                                        href="#comment-area">{{ answer.comment_set.count }} 评论</a></span>
                                <span class="views-count"><a>{{ answer.views }} 阅读</a></span>
                                {% if delete_allowance == 'allowed' %}
                                    <span class="button"><a href="#" onclick="confirm_safe_delete()">删除回答</a>
                        <form style="display:none;" id="safe_delete" action="{% url 'blog:answer_delete' answer.id %}"
                              method="POST">
                            {% csrf_token %}
                            <button type="submit">发送</button>
                        </form>
                        </span>
                                    <span class="button"><a
                                            href="{% url 'blog:answer_edit' answer.id %}">编辑回答</a></span>
                                {% endif %}
                            </div>
                        </header>
                        <div class="entry-content clearfix">
                            {{ answer.body|safe }}
                        </div>
                    </article>
                    <section class="comment-area" id="comment-area">
                        <h3>发表评论</h3>
                        {% show_comment_form answer %}
                        {% block message %}
                        {% endblock %}
                    </section>
                {% else %}
                    <article class="post post-{{ answer.id }}">
                        <header class="entry-header">
                            <h1 class="entry-title">{{ answer.title }}</h1>
                            <div class="entry-meta">
                    <span class="post-date"><a><time class="entry-date"
                                                     datetime="{{ answer.created_time }}">{{ answer.created_time }}</time></a></span>
                                <span class="post-author"><a href="#">{{ answer.author }}</a></span>
                                <span class="comments-link"><a
                                        href="#comment-area">{{ answer.comment_set.count }} 评论</a></span>
                                <span class="views-count"><a>{{ answer.views }} 阅读</a></span>
                            </div>
                        </header>
                        <div class="entry-content clearfix">
                            {{ answer.body|safe }}
                        </div>
                    </article>
                    <section class="comment-area" id="comment-area">
                    </section>
                {% endif %}
                {% load mptt_tags %}
                <h3>评论列表，共 <span>{{ comment_count }}</span> 条评论</h3>
                <div class="row">
                    <!-- 遍历树形结构 -->
                    {% recursetree comment_list %}
                        <!-- 给 node 取个别名 comment -->
                        {% with comment=node %}
                            <div class="{% if comment.reply_to %}
                            offset-1 col-11
                        {% else %}
                            col-12
                        {% endif %}"
                            >
                                <hr>
                                <p>
                                    <strong style="color: dodgerblue">
                                        {{ comment.author.name }}
                                    </strong>
                                    {% if comment.reply_to %}
                                        <i class="far fa-arrow-alt-circle-right"
                                           style="color: cornflowerblue;"
                                        ></i>
                                        <strong style="color: pink">
                                            {{ comment.reply_to }}
                                        </strong>
                                    {% endif %}
                                </p>
                                <div>{{ comment.body|safe }}</div>
                                <div>
                    <span style="color: gray">
                        {{ comment.created_time|date:"Y-m-d H:i" }}
                    </span>

                                    <!-- 加载 modal 的按钮 -->
                                    {% if request.session.is_login %}
                                        <button type="button" class="btn btn-light btn-sm text-muted"
                                                onclick="load_modal({{ answer.id }}, {{ comment.id }})">回复
                                        </button>
                                    {% endif %}
                                </div>
                                <!-- Modal -->
                                <div class="modal fade" id="comment_{{ comment.id }}" tabindex="-1"
                                     role="dialog"
                                     aria-labelledby="CommentModalCenter" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                                        <div class="modal-content" style="height: 480px">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalCenterTitle">
                                                    回复 {{ comment.author.name }}:</h5>
                                            </div>
                                            <div class="modal-body" id="modal_body_{{ comment.id }}"></div>
                                        </div>
                                    </div>
                                </div>
                                {% if not comment.is_leaf_node %}
                                    <div class="children">
                                        {{ children }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endwith %}
                    {% endrecursetree %}
                </div>
            </div>
            <div class="col-md-4">
                <div class="sidebar">
                    {% block toc %}
                        {% if answer.toc %}
                            <div class="widget widget-content">
                                <h3 class="widget-title">目录</h3>{{ answer.toc|safe }}
                            </div>
                        {% endif %}
                    {% endblock %}
                    {% show_authors answer.author %}
                    <div class="rss">
                        <a href="{% url 'blog:money' %}"><span class="ion-social-rss-outline"></span>大哥大嫂过年好!</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        function confirm_safe_delete() {
            layer.open({
                title: "确认删除",
                content: "确认删除这个回答吗?",
                yes: function (index, layero) {
                    $('form#safe_delete button').click();
                    layer.close(index);
                }
            })
        }
    </script>
    <script>
        // 加载 modal
        function load_modal(article_id, comment_id) {
            let modal_body = '#modal_body_' + comment_id;
            let modal_id = '#comment_' + comment_id;

            // 加载编辑器
            if ($(modal_body).children().length === 0) {
                let content = '<iframe src="/comments/' +
                    article_id +
                    '/' +
                    comment_id +
                    '"' +
                    ' frameborder="0" style="width: 100%; height: 100%;" id="iframe_' +
                    comment_id +
                    '"></iframe>';
                $(modal_body).append(content);
            }
            ;
            $(modal_id).modal('show');
        }
    </script>
{% endblock script %}